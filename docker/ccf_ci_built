# CCF Continuous Integration image for SNP
# Contains CCF build dependencies and toolchain for target platform
# Also contains CCF source and build directory

# Latest image as of this change
ARG base=mcr.microsoft.com/azurelinux/base/core:3.0
FROM ${base}

# SSH. Note that this could (should) be done in the base ccf_ci image instead
# if we wanted to build this image faster
RUN tdnf -y update \
    && tdnf -y install openssh-server \
    && sed -i "s/.*PubkeyAuthentication.*/PubkeyAuthentication yes/g" /etc/ssh/sshd_config \
    && sed -i "s/.*PasswordAuthentication.*/PasswordAuthentication no/g" /etc/ssh/sshd_config \
    && mkdir -p /run/sshd # To avoid "Missing privilege separation directory: /run/sshd" error

# CI Agent user
ARG user="agent"
RUN useradd -m $user \
    && echo "$user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers \
    && mkdir /home/$user/.ssh \
    && chown -R $user:$user /home/$user/.ssh

# Copy CCF source and build
RUN mkdir /CCF
COPY . /CCF/
RUN gpg --import /etc/pki/rpm-gpg/MICROSOFT-RPM-GPG-KEY \
    && tdnf -y update \
    && tdnf -y install ca-certificates git \
    && /CCF/scripts/./install-azure-linux-deps.sh
RUN mkdir /CCF/build \
    && cd /CCF/build \
    && CC=`which clang` CXX=`which clang++` cmake -GNinja -DCOMPILE_TARGET=snp .. \
    && ninja \ 
    && chmod -R 777 /CCF

CMD ["/usr/sbin/sshd", "-D"]
